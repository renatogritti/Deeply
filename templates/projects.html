<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Projects - Deeply</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/projects.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%238A05BE'/><text x='50%' y='55%' font-size='50' fill='white' text-anchor='middle' dominant-baseline='middle'>D</text></svg>">
    <script src="{{ url_for('static', filename='js/projects.js') }}" defer></script>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <svg class="logo" viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
            </svg>
            <h1>Manage Projects</h1>
        </div>
    </div>

    <div class="sidebar">
        <a href="{{ add_project_param('/kanban') }}" class="back-button">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M4 3C2.89 3 2 3.89 2 5V19C2 20.11 2.89 21 4 21H20C21.11 21 22 20.11 22 19V5C22 3.89 21.11 3 20 3H4M4 5H20V19H4V5M6 7V17H10V7H6M12 7V11H16V7H12M12 13V17H16V13H12Z"/>
            </svg>
            <span class="back-text">Voltar ao Kanban</span>
        </a>
        </button>
    </div>

    <div class="projects-container">
        <!-- Form para criar novo projeto -->
        <div class="new-project-form">
            <h2>Create New Project</h2>
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectName">Project Name*</label>
                    <div class="form-input-wrapper">
                        <input type="text" id="projectName" class="form-input" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="projectDescription">Description</label>
                    <div class="form-input-wrapper">
                        <textarea id="projectDescription" class="form-input" rows="4" placeholder="Enter a description for your project..."></textarea>
                    </div>
                    <button type="button" id="aiAssistantBtn" class="ai-button" onclick="openAIModal()">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <path fill="currentColor" d="M12,2C13.85,2 15.55,2.78 16.9,4.1L18.6,2.4L19.9,3.7L18.2,5.4C19.5,6.75 20.3,8.45 20.3,10.3C20.3,13.95 17.95,17.1 14.7,18.3L13.4,16.95C16.2,15.95 18.1,13.3 18.1,10.3C18.1,7.05 15.35,4.3 12.1,4.3C8.85,4.3 6.1,7.05 6.1,10.3C6.1,13.3 8,15.95 10.8,16.95L9.5,18.3C6.25,17.1 3.9,13.95 3.9,10.3C3.9,8.45 4.7,6.75 6,5.4L4.3,3.7L5.6,2.4L7.3,4.1C8.65,2.78 10.35,2 12.2,2H12Z"/>
                        </svg>
                        Assistente de AI para Briefing
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Templates (opcional)</label>
                    <select id="columnTemplate" class="form-input" onchange="fillColumns()">
                        <option value="">Selecione um template ou crie manualmente</option>
                        <option value="tecnologia">Tecnologia & Desenvolvimento</option>
                        <option value="manufatura">Manufatura & Indústria</option>
                        <option value="marketing">Marketing & Publicidade</option>
                        <option value="saude">Saúde & Medicina</option>
                        <option value="juridico">Jurídico & Advocacia</option>
                        <option value="recursos_humanos">Recursos Humanos</option>
                        <option value="construcao_civil">Construção Civil</option>
                    </select>
                </div>

                <div id="phasesContainer" class="phases-container">
                    <div class="phases-section">
                        <div class="phases-header">
                            <h3>Phases</h3>
                            <button type="button" onclick="addPhase()" class="add-phase-btn">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                </svg>
                                Add Phase
                            </button>
                        </div>
                        
                        <div id="phasesList" class="phases-list">
                            <div class="phase-item">
                                <span class="drag-handle">⋮</span>
                                <input type="text" class="phase-name" placeholder="Phase Name" required>
                            </div>
                        </div>
                        
                        <div class="phase-instructions">
                            <small>* At least one phase is required</small>
                            <small>* Drag phases to reorder them</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="primary-button">Create Project</button>
                </div>
            </form>
        </div>

        <!-- Lista de projetos existentes -->
        <div class="projects-list">
            <h2>Existing Projects</h2>
            <div id="projectsList">
                {% for project in projects %}
                <div class="project-card" data-id="{{ project.id }}">
                    <div class="project-header">
                        <h3>{{ project.name }}</h3>
                        <div class="project-actions">
                            <div class="button-group">
                                <button onclick="editProject({{ project.id }})" class="edit-btn">Edit</button>
                                <button onclick="deleteProject({{ project.id }})" class="delete-btn">Delete</button>
                            </div>
                            <button onclick="exportProject({{ project.id }})" class="export-btn">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path fill="currentColor" d="M23 12l-4-4v3h-9v2h9v3l4-4M15 16H4V8h11V6H4c-1.11 0-2 .89-2 2v8c0 1.11.89 2 2 2h11v-2z"/>
                                </svg>
                                Export
                            </button>
                            <button onclick="showImportModal({{ project.id }})" class="import-btn">
                                <svg viewBox="0 0 24 24" width="16" height="16">
                                    <path fill="currentColor" d="M14 2H6c-1.11 0-2 .89-2 2v16c0 1.11.89 2 2 2h12c1.11 0 2-.89 2-2V8l-6-6zm-1 12h-2v3l-3-3h2V8h3v6zm3.5-4H19v6h-6.5l2-2H17v-2h-2.5l2-2z"/>
                                </svg>
                                Import
                            </button>
                        </div>
                    </div>
                    <p class="project-description">{{ project.description or 'No description' }}</p>
                    <div class="project-phases">
                        <h4>Phases:</h4>
                        <div class="phases-chips">
                            {% for phase in project.phases %}
                            <span class="phase-chip">{{ phase.name }}</span>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>Import Cards</h3>
            <form id="importForm" enctype="multipart/form-data">
                <input type="file" name="file" accept=".xlsx" required>
                <input type="hidden" name="project_id" id="importProjectId">
                <div class="modal-buttons">
                    <button type="button" onclick="closeImportModal()" class="cancel-btn">Cancel</button>
                    <button type="submit" class="confirm-btn">Import</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal do Assistente AI -->
    <div id="aiModal" class="modal">
        <div class="modal-content ai-modal-content">
            <div class="modal-header">
                <h3>
                    <svg class="logo" viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M12,2C13.85,2 15.55,2.78 16.9,4.1L18.6,2.4L19.9,3.7L18.2,5.4C19.5,6.75 20.3,8.45 20.3,10.3C20.3,13.95 17.95,17.1 14.7,18.3L13.4,16.95C16.2,15.95 18.1,13.3 18.1,10.3C18.1,7.05 15.35,4.3 12.1,4.3C8.85,4.3 6.1,7.05 6.1,10.3C6.1,13.3 8,15.95 10.8,16.95L9.5,18.3C6.25,17.1 3.9,13.95 3.9,10.3C3.9,8.45 4.7,6.75 6,5.4L4.3,3.7L5.6,2.4L7.3,4.1C8.65,2.78 10.35,2 12.2,2H12Z"/>
                    </svg>
                    Assistente de Briefing
                </h3>
                <span class="close-btn" onclick="closeAIModal()">&times;</span>
            </div>
            <div class="ai-container">
                <div id="ai-chat-messages" class="chat-messages"></div>
                
                <div class="input-container">
                    <textarea 
                        id="aiUserInput" 
                        placeholder="Digite sua resposta..."
                        rows="1"
                        onInput="this.rows = Math.min(5, this.value.split('\n').length)"
                    ></textarea>
                    <button onclick="sendBriefingResponse()">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M3.4 20.4L20.85 12.92C21.66 12.57 21.66 11.43 20.85 11.08L3.4 3.6C2.74 3.31 2.01 3.8 2.01 4.51L2 9.12C2 9.62 2.37 10.05 2.87 10.11L17 12L2.87 13.88C2.37 13.95 2 14.38 2 14.88L2.01 19.49C2.01 20.2 2.74 20.69 3.4 20.4Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Drag and drop para as fases
        let draggedItem = null;

        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
            setupFormSubmission();
        });

        function setupDragAndDrop() {
            const phasesList = document.getElementById('phasesList');
            
            phasesList.addEventListener('dragstart', e => {
                if (e.target.classList.contains('phase-item')) {
                    draggedItem = e.target;
                    e.target.classList.add('dragging');
                }
            });

            phasesList.addEventListener('dragend', e => {
                if (e.target.classList.contains('phase-item')) {
                    e.target.classList.remove('dragging');
                }
            });

            phasesList.addEventListener('dragover', e => {
                e.preventDefault();
                if (draggedItem) {
                    const closestPhase = getClosestPhase(phasesList, e.clientY);
                    if (closestPhase) {
                        phasesList.insertBefore(draggedItem, closestPhase);
                    } else {
                        phasesList.appendChild(draggedItem);
                    }
                }
            });
        }

        function getClosestPhase(container, y) {
            const draggableElements = [...container.querySelectorAll('.phase-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function addPhase() {
            const phasesList = document.getElementById('phasesList');
            const phaseDiv = document.createElement('div');
            phaseDiv.className = 'phase-item';
            phaseDiv.draggable = true;
            phaseDiv.innerHTML = `
                <span class="drag-handle">⋮</span>
                <input type="text" class="phase-name" placeholder="Phase Name" required>
                <button type="button" class="remove-phase" onclick="this.parentElement.remove()">&times;</button>
            `;
            phasesList.appendChild(phaseDiv);
        }

        function setupFormSubmission() {
            document.getElementById('projectForm').onsubmit = async (e) => {
                e.preventDefault();
                
                const phases = Array.from(document.querySelectorAll('.phase-name'))
                    .map(input => ({ name: input.value.trim() }))
                    .filter(phase => phase.name !== '');

                if (phases.length === 0) {
                    alert('At least one phase is required!');
                    return;
                }

                const projectData = {
                    name: document.getElementById('projectName').value,
                    description: document.getElementById('projectDescription').value,
                    phases: phases
                };

                try {
                    const response = await fetch('/api/projects', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(projectData)
                    });

                    const result = await response.json();
                    if (result.success) {
                        window.location.reload();
                    } else {
                        alert('Error creating project: ' + result.error);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error creating project');
                }
            };
        }

        // Funções para edição e exclusão
        async function deleteProject(id) {
            if (!confirm('Are you sure? This will delete all cards in this project.')) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error deleting project: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error deleting project');
            }
        }

        async function editProject(id) {
            // Implementar edição de projeto
            alert('Edit project feature coming soon!');
        }

        async function exportProject(id) {
            try {
                window.location.href = `/api/projects/${id}/export`;
            } catch (error) {
                console.error('Error:', error);
                alert('Error exporting project');
            }
        }

        function showImportModal(projectId) {
            document.getElementById('importModal').style.display = 'block';
            document.getElementById('importProjectId').value = projectId;
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        document.getElementById('importForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const projectId = document.getElementById('importProjectId').value;

            try {
                const response = await fetch(`/api/projects/${projectId}/import`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    window.location.reload();
                } else if (result.error_log) {
                    // Download do log de erros
                    window.location.href = `/api/projects/${projectId}/error_log`;
                } else {
                    alert('Error importing cards: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error importing cards');
            }
        }

        function fillColumns() {
            const templates = {
                'tecnologia': ['Backlog', 'Em Desenvolvimento', 'Code Review', 'Testes', 'Deploy', 'Concluído'],
                'manufatura': ['Matéria-prima', 'Produção', 'Controle Qualidade', 'Embalagem', 'Expedição', 'Concluído'],
                'marketing': ['Ideias', 'Planejamento', 'Criação', 'Revisão', 'Aprovação', 'Publicado'],
                'saude': ['Triagem', 'Em Atendimento', 'Exames', 'Diagnóstico', 'Tratamento', 'Alta'],
                'juridico': ['Novo Caso', 'Análise', 'Documentação', 'Audiências', 'Sentença', 'Arquivado'],
                'recursos_humanos': ['Candidatos', 'Triagem', 'Entrevistas', 'Oferta', 'Contratação', 'Onboarding'],
                'construcao_civil': ['Projeto', 'Licenças', 'Execução', 'Inspeção', 'Acabamento', 'Entrega']
            };

            const select = document.getElementById('columnTemplate');
            const phasesList = document.getElementById('phasesList');
            const template = select.value;

            // Limpa a lista atual
            phasesList.innerHTML = '';

            // Se um template foi selecionado, adiciona as fases
            if (template && templates[template]) {
                templates[template].forEach(phase => {
                    const div = document.createElement('div');
                    div.className = 'phase-item';
                    div.draggable = true;
                    div.innerHTML = `
                        <span class="drag-handle">⋮</span>
                        <input type="text" class="phase-name" value="${phase}" required>
                        <button type="button" class="remove-phase" onclick="this.parentElement.remove()">&times;</button>
                    `;
                    phasesList.appendChild(div);
                });
            } else {
                // Adiciona uma fase vazia se nenhum template for selecionado
                phasesList.innerHTML = `
                    <div class="phase-item" draggable="true">
                        <span class="drag-handle">⋮</span>
                        <input type="text" class="phase-name" placeholder="Phase Name" required>
                        <button type="button" class="remove-phase" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                `;
            }
        }

        // Variáveis para controle do assistente de briefing
        let briefingStep = 0;
        const briefingQuestions = [
            "Qual é o objetivo principal deste projeto?\n(O que você espera alcançar com ele?)",
            "Quem é o público-alvo?\n(Para quem isso está sendo feito?)",
            "Quais são os principais requisitos ou funcionalidades desejadas?\n(O que não pode faltar?)",
            "Existe alguma referência, inspiração ou expectativa visual/funcional?\n(Tem algo que você viu e gostaria de seguir como base?)",
            "Qual é o prazo ideal para entrega e existe um orçamento definido?\n(Tem datas ou limites financeiros já estabelecidos?)"
        ];
        const briefingAnswers = {
            objetivo: "",
            publico: "",
            requisitos: "",
            referencias: "",
            prazo: ""
        };
        let briefingSummary = "";
        let isWaitingConfirmation = false;

        // Funções para o modal do assistente
        function openAIModal() {
            document.getElementById('aiModal').style.display = 'block';
            resetBriefingChat();
        }

        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        function resetBriefingChat() {
            const chatMessages = document.getElementById('ai-chat-messages');
            chatMessages.innerHTML = '';
            briefingStep = 0;
            isWaitingConfirmation = false;
            
            // Mensagem de boas-vindas
            addAIMessage("Olá! Sou o assistente de briefing da Deeply. Vou te ajudar a criar uma descrição detalhada para seu projeto através de algumas perguntas rápidas. Vamos começar?");
            
            // Primeira pergunta após pequeno delay
            setTimeout(() => {
                addAIMessage(briefingQuestions[0]);
            }, 1000);
        }

        function addAIMessage(message) {
            const chatMessages = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message';
            chatMessages.appendChild(messageDiv);
            typeWriter(message, messageDiv, 0, 10);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addUserMessage(message) {
            const chatMessages = document.getElementById('ai-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function typeWriter(text, element, index, speed) {
            if (index < text.length) {
                element.innerHTML = text.substring(0, index + 1);
                index++;
                
                // Ajusta velocidade para pausas naturais
                let currentSpeed = speed;
                if (text.charAt(index - 1) === '.') {
                    currentSpeed = speed * 1.6;
                } else if (text.charAt(index - 1) === ',') {
                    currentSpeed = speed;
                }
                
                setTimeout(() => typeWriter(text, element, index, speed), currentSpeed);
            }
        }

        function sendBriefingResponse() {
            const input = document.getElementById('aiUserInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            if (isWaitingConfirmation) {
                if (message.toLowerCase().includes('sim') || 
                    message.toLowerCase().includes('yes') || 
                    message.toLowerCase().includes('ok') || 
                    message.toLowerCase().includes('confirmo')) {
                    
                    // Aplica o sumário ao campo de descrição
                    document.getElementById('projectDescription').value = briefingSummary;
                    addAIMessage("Ótimo! O briefing foi aplicado ao campo de descrição do projeto. Você pode editar mais detalhes se quiser. Estou fechando o assistente.");
                    
                    // Fecha o modal após 3 segundos
                    setTimeout(() => {
                        closeAIModal();
                    }, 3000);
                } else {
                    addAIMessage("Sem problemas! Você pode editar o briefing manualmente ou reiniciar este assistente quando quiser. Estou fechando o assistente.");
                    setTimeout(() => {
                        closeAIModal();
                    }, 3000);
                }
                return;
            }
            
            // Guarda a resposta da pergunta atual
            switch (briefingStep) {
                case 0:
                    briefingAnswers.objetivo = message;
                    break;
                case 1:
                    briefingAnswers.publico = message;
                    break;
                case 2:
                    briefingAnswers.requisitos = message;
                    break;
                case 3:
                    briefingAnswers.referencias = message;
                    break;
                case 4:
                    briefingAnswers.prazo = message;
                    break;
            }
            
            briefingStep++;
            
            if (briefingStep < briefingQuestions.length) {
                // Próxima pergunta
                setTimeout(() => {
                    addAIMessage(briefingQuestions[briefingStep]);
                }, 500);
            } else {
                // Finaliza o questionário e gera o sumário
                setTimeout(() => {
                    addAIMessage("Obrigado pelas informações! Estou gerando o briefing do projeto...");
                    
                    // Gerar o sumário
                    setTimeout(() => {
                        generateBriefingSummary();
                    }, 1500);
                }, 500);
            }
        }

        function generateBriefingSummary() {
            // Gera o sumário com base nas respostas
            briefingSummary = `# Briefing do Projeto

## Objetivo Principal
${briefingAnswers.objetivo}

## Público-Alvo
${briefingAnswers.publico}

## Requisitos e Funcionalidades Principais
${briefingAnswers.requisitos}

## Referências e Inspirações
${briefingAnswers.referencias}

## Prazos e Orçamento
${briefingAnswers.prazo}`;

            // Exibe o sumário e pergunta se deseja aplicar
            addAIMessage("Aqui está o briefing do seu projeto:\n\n" + briefingSummary + "\n\nDeseja aplicar este briefing à descrição do projeto? (Responda sim ou não)");
            
            isWaitingConfirmation = true;
        }

        // Adiciona evento de tecla ao campo de entrada
        document.getElementById('aiUserInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendBriefingResponse();
            }
        });
    </script>
</body>
</html>
