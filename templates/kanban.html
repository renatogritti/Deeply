<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deeply</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="theme-color" content="#8A05BE">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"></noscript>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <svg class="logo" viewBox="0 0 24 24">
                <path d="M4 3C2.89 3 2 3.89 2 5V19C2 20.11 2.89 21 4 21H20C21.11 21 22 20.11 22 19V5C22 3.89 21.11 3 20 3H4M4 5H20V19H4V5M6 7V17H10V7H6M12 7V11H16V7H12M12 13V17H16V13H12Z"/>
            </svg>
            <h1>Deeply</h1>
        </div>
        
        <div class="header-content">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Buscar cards...">
            </div>

            <!-- Novo widget Pomodoro -->
            <div class="pomodoro-widget">
                <div class="timer-display">25:00</div>
                <div class="timer-controls">
                    <button class="timer-button" id="startTimer">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <path fill="currentColor" d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                        </svg>
                    </button>
                    <button class="timer-button" id="resetTimer">
                        <svg viewBox="0 0 24 24" width="16" height="16">
                            <path fill="currentColor" d="M12,5V1L7,6L12,11V7A6,6 0 0,1 18,13A6,6 0 0,1 12,19A6,6 0 0,1 6,13H4A8,8 0 0,0 12,21A8,8 0 0,0 20,13A8,8 0 0,0 12,5Z"/>
                        </svg>
                    </button>
                </div>
                <div class="timer-mode">
                    <button class="mode-button active" data-time="25">Pomodoro</button>
                    <button class="mode-button" data-time="5">Break</button>
                </div>
            </div>


        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="btn-group">
            <a href="{{ url_for('calendar') }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-calendar"></i> Calendário
            </a>
        </div>
    </div>

    <div class="sidebar">
        <!-- Botão do Messenger - Agora como primeiro botão -->
        <button class="sidebar-button" onclick="window.location.href='/messenger'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4A2,2 0 0,0 20,2M6,9H18V11H6M14,14H6V12H14M18,8H6V6H18" />
            </svg>
            <span>Messenger</span>
        </button>

        <!-- Botão de Calendário -->
        <button class="sidebar-button" onclick="window.location.href='/calendar'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z" />
            </svg>
            <span>Calendar View</span>
        </button>

        <!-- Botão TODO -->
        <button class="sidebar-button" onclick="window.location.href='/todo'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,5V19H5V5H19M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9" />
            </svg>
            <span>TODO Lists</span>
        </button>
        
        <button class="sidebar-button" onclick="window.location.href='/docs'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M14,17H7V15H14M17,13H7V11H17M17,9H7V7H17M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3Z" />
            </svg>
            <span>Documents</span>
        </button>

        <button class="sidebar-button" onclick="window.location.href='/projects'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
            </svg>
            <span>Manage Projects</span>
        </button>
        
        <button class="sidebar-button" onclick="window.location.href='/teams'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z"/>
            </svg>
            <span>Manage Users</span>
        </button>
        
        <button class="sidebar-button" onclick="window.location.href='/tags'">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.78,14.05 22,13.55 22,13C22,12.44 21.77,11.94 21.41,11.58Z"/>
            </svg>
            <span>Manage Tags</span>
        </button>
    </div>

    <div class="filter-header">
        <div class="project-filter">
            <select id="projectFilter" onchange="applyFilters()">
            <option value="">All Projects</option>
            {% for project in projects %}
                <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
            </select>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/pomodoro.js') }}"></script>

    <!-- ...rest of the code... -->

    <div class="frames-container">
        <div class="filter-frame">
            <div class="project-filter">
                <select id="projectFilter" onchange="applyFilters()">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="kanban-board">
            <!-- As colunas serão geradas dinamicamente pelo JavaScript -->
        </div>
    </div>

    <script>
        function allowDrop(event) {
            event.preventDefault();
        }


        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }


        function createCard(id, title, description, tempo, team_name, tags = [], project_id, deadline = null, users = []) {
            var card = document.createElement("div");
            card.className = "kanban-card";
            card.id = id;
            card.draggable = true;
            card.ondragstart = drag;
            card.ondblclick = editCard;
            card.setAttribute('data-project-id', project_id);
            card.setAttribute('data-description', description);

            var cardTitle = document.createElement("h3");
            cardTitle.textContent = title;
            card.appendChild(cardTitle);

            var cardTempo = document.createElement("p");
            cardTempo.textContent = "Tempo: " + tempo;
            card.appendChild(cardTempo);

            if (deadline) {
                var cardDeadline = document.createElement("p");
                cardDeadline.textContent = "Deadline: " + new Date(deadline).toLocaleDateString();
                cardDeadline.className = "card-deadline";
                card.appendChild(cardDeadline);
            }

            if (team_name) {
                var teamTag = document.createElement("div");
                teamTag.className = "team-tag";
                teamTag.textContent = team_name;
                card.appendChild(teamTag);
            }

            if (tags && tags.length > 0) {
                var tagsContainer = document.createElement("div");
                tagsContainer.className = "card-tags";
                tags.forEach(tag => {
                    var tagElement = document.createElement("span");
                    tagElement.className = "card-tag";
                    tagElement.textContent = tag.name;
                    tagElement.style.backgroundColor = tag.color;
                    tagsContainer.appendChild(tagElement);
                });
                card.appendChild(tagsContainer);
            }

            if (users && users.length > 0) {
                var usersContainer = document.createElement("div");
                usersContainer.className = "card-users";
                users.forEach(user => {
                    var userTag = document.createElement("div");
                    userTag.className = "user-tag";
                    userTag.textContent = user.name;
                    usersContainer.appendChild(userTag);
                });
                card.appendChild(usersContainer);
            }

            return card;
        }

        function openNewCardModal(phase_id) {
            const modal = document.getElementById("createModal");
            const newCardProject = document.getElementById("newCardProject");
            const selectedProjectId = document.getElementById("projectFilter").value;

            modal.style.display = "block";
            
            // Limpar campos
            document.getElementById("newCardTitle").value = "";
            document.getElementById("newCardDescription").value = "";
            document.getElementById("newCardTempo").value = "";
            document.getElementById("newCardDeadline").value = "";

            // Carregar usuários primeiro
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    // Atualizar lista de usuários
                    const userSelect = document.getElementById('newCardUsers');
                    userSelect.innerHTML = teams.map(team => 
                        `<option value="${team.id}">${team.name}</option>`
                    ).join('');
                    
                    // Depois de carregar usuários, configurar projeto e fases
                    if (selectedProjectId) {
                        newCardProject.value = selectedProjectId;
                        newCardProject.disabled = true;
                        loadPhasesByProject(selectedProjectId).then(() => {
                            if (phase_id) {
                                document.getElementById("newCardPhase").value = phase_id.replace('phase_', '');
                            }
                        });
                    }
                    
                    // Carregar tags
                    loadTags();
                })
                .catch(error => {
                    console.error('Error loading teams:', error);
                    alert('Error loading users list');
                });
        }

        function loadTeamsList() {
            return fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    // Atualizar lista de usuários no modal de criar card
                    const userSelect = document.getElementById('newCardUsers');
                    if (userSelect) {
                        userSelect.innerHTML = teams.map(team => 
                            `<option value="${team.id}">${team.name}</option>`
                        ).join('');
                    }

                    // Atualizar lista de usuários no modal de editar card
                    const editUserSelect = document.getElementById('editCardUsers');
                    if (editUserSelect) {
                        editUserSelect.innerHTML = teams.map(team => 
                            `<option value="${team.id}">${team.name}</option>`
                        ).join('');
                    }

                    // Atualizar lista de times
                    const teamsList = document.getElementById("teamsList");
                    if (teamsList) {
                        teamsList.innerHTML = teams.map(team => `
                            <div class="team-item">
                                <div>
                                    <div>${team.name}</div>
                                    <div style="font-size: 0.8em; color: #666;">${team.description}</div>
                                </div>
                                <div>
                                    <button onclick="editTeam(${team.id})">Edit</button>
                                    <button onclick="deleteTeam(${team.id})">Delete</button>
                                </div>
                            </div>
                        `).join('');
                    }
                });
        }

        function closeCreateModal() {
            document.getElementById("createModal").style.display = "none";
            document.getElementById("newCardTitle").value = "";
            document.getElementById("newCardDescription").value = "";
            document.getElementById("newCardTempo").value = "";
            document.getElementById("newCardProject").disabled = false;
        }


        function closeModal() {
            document.getElementById("editModal").style.display = "none";
        }


        function createNewCard() {
            const title = document.getElementById("newCardTitle").value;
            const description = document.getElementById("newCardDescription").value;
            const tempo = document.getElementById("newCardTempo").value;
            const deadline = document.getElementById("newCardDeadline").value;
            const phase_id = document.getElementById("newCardPhase").value;
            const projectId = document.getElementById("newCardProject").value;
            const selectedTags = Array.from(document.querySelectorAll('#newCardTags input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.value));
            const selectedUsers = Array.from(document.getElementById('newCardUsers').selectedOptions)
                .map(option => parseInt(option.value));
            const id = "card" + Date.now();

            if (!title || !description || !tempo) {
                alert("Please fill in all required fields!");
                return;
            }

            if (!projectId) {
                alert("Please select a project!");
                return;
            }

            if (!phase_id) {
                alert("Please select a phase!");
                return;
            }

            fetch('/api/cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                    title: title,
                    description: description,
                    tempo: tempo,
                    deadline: deadline || null,
                    phase_id: phase_id,
                    project_id: projectId,
                    tag_ids: selectedTags,
                    user_ids: selectedUsers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const card = createCard(
                        id, 
                        title, 
                        description, 
                        tempo, 
                        null, // não tem mais team_name
                        data.card.tags,
                        projectId, 
                        deadline, 
                        data.card.users
                    );

                    document.getElementById(`phase_${phase_id}`).appendChild(card);
                    closeCreateModal();
                    
                    document.querySelectorAll('#newCardTags input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                } else {
                    alert('Error creating card: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating card');
            });
        }


        function editCard(event) {
            const card = event.currentTarget;
            const modal = document.getElementById("editModal");
            
            const title = card.querySelector("h3").textContent;
            const description = card.getAttribute('data-description');
            const tempo = card.querySelector("p").textContent.replace("Tempo: ", "");
            const deadlineEl = card.querySelector(".card-deadline");
            const teamTag = card.querySelector(".team-tag");
            const projectId = card.getAttribute('data-project-id');

            document.getElementById("editCardId").value = card.id;
            document.getElementById("editCardProject").value = projectId;
            document.getElementById("editCardTitle").value = title;
            document.getElementById("editCardDescription").value = description;
            document.getElementById("editCardTempo").value = tempo;
            document.getElementById("editCardProject").disabled = true;

            if (deadlineEl) {
                const deadlineText = deadlineEl.textContent.replace("Deadline: ", "");
                const parts = deadlineText.split('/');
                const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                document.getElementById("editCardDeadline").value = formattedDate;
            } else {
                document.getElementById("editCardDeadline").value = "";
            }

            const teamSelect = document.getElementById("editCardTeam");
            if (teamTag) {
                const teamName = teamTag.textContent;
                Array.from(teamSelect.options).forEach(option => {
                    if (option.text === teamName) {
                        option.selected = true;
                    }
                });
            } else {
                teamSelect.value = "";
            }

            // Limpar seleções anteriores
            document.querySelectorAll('#editCardTags input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.querySelectorAll('#editCardUsers option').forEach(option => {
                option.selected = false;
            });

            fetch(`/api/cards/${card.id}`)
                .then(response => response.json())
                .then(data => {
                    // Atualizar tags
                    const cardTags = data.tags || [];
                    const checkboxes = document.querySelectorAll('#editCardTags input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = cardTags.some(tag => tag.id === parseInt(checkbox.value));
                    });

                    // Atualizar usuários
                    const userSelect = document.getElementById('editCardUsers');
                    const cardUsers = data.users || [];
                    Array.from(userSelect.options).forEach(option => {
                        option.selected = cardUsers.some(user => user.id === parseInt(option.value));
                    });
                });

            modal.style.display = "block";
        }


        function saveCardEdit() {
            const id = document.getElementById("editCardId").value;
            const card = document.getElementById(id);
            const data = {
                title: document.getElementById("editCardTitle").value,
                description: document.getElementById("editCardDescription").value,
                tempo: document.getElementById("editCardTempo").value,
                deadline: document.getElementById("editCardDeadline").value,
                team_id: document.getElementById("editCardTeam").value || null,
                tag_ids: Array.from(document.querySelectorAll('#editCardTags input[type="checkbox"]:checked'))
                    .map(checkbox => parseInt(checkbox.value)),
                user_ids: Array.from(document.getElementById('editCardUsers').selectedOptions)
                    .map(option => parseInt(option.value))
            };

            fetch(`/api/cards/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const projectId = document.getElementById("editCardProject").value;
                    const teamId = document.getElementById("editCardTeam").value;
                    const teamName = teamId ? document.getElementById("editCardTeam").options[document.getElementById("editCardTeam").selectedIndex].text : null;

                    const updatedCard = createCard(
                        id,
                        document.getElementById("editCardTitle").value,
                        document.getElementById("editCardDescription").value,
                        document.getElementById("editCardTempo").value,
                        teamName,
                        data.card.tags,
                        projectId,
                        document.getElementById("editCardDeadline").value,
                        data.card.users
                    );

                    const currentCard = document.getElementById(id);
                    currentCard.innerHTML = updatedCard.innerHTML;
                    currentCard.className = updatedCard.className;
                    currentCard.draggable = true;
                    currentCard.ondragstart = drag;
                    currentCard.ondblclick = editCard;
                    currentCard.setAttribute('data-project-id', projectId);

                    closeModal();
                } else {
                    alert('Error updating card: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating card');
            });
        }


        function deleteCard() {
            const id = document.getElementById("editCardId").value;
            const card = document.getElementById(id);

            if (confirm('Are you sure you want to delete this card?')) {
                fetch(`/api/cards/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        card.remove();
                        closeModal();
                    } else {
                        alert('Error deleting card: ' + data.error);
                    }
                })
                .catch(error => alert('Error deleting card'));
            }
        }


        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const card = document.getElementById(data);
            const newColumn = event.target.closest('.kanban-column');
           
            if (newColumn) {
                const phase_id = newColumn.id.replace('phase_', '');
                fetch(`/api/cards/${data}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phase_id: parseInt(phase_id)  // Atualizado: usar phase_id ao invés de column
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        newColumn.appendChild(card);
                    } else {
                        alert('Error moving card: ' + data.error);
                    }
                })
                .catch(error => alert('Error moving card'));
            }
        }


        function loadTags() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(tags => {
                    updateTagSelectors(tags);
                });
        }


        function createTag() {
            const name = document.getElementById("tagName").value;
            const color = document.getElementById("tagColor").value;

            if (!name) {
                alert("Tag name is required!");
                return;
            }

            fetch('/api/tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, color })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("tagName").value = "";
                    loadTags();
                    loadTagsList();
                } else {
                    alert('Error creating tag: ' + data.error);
                }
            });
        }


        function updateTagSelectors(tags) {
            const containers = document.querySelectorAll('.tags-selection');
            containers.forEach(container => {
                container.innerHTML = tags.map(tag => `
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag_${tag.id}" value="${tag.id}">
                        <label for="tag_${tag.id}" style="background-color: ${tag.color}">${tag.name}</label>
                    </div>
                `).join('');
            });
        }


        function openTagModal() {
            showModal('tagModal');
            loadTagsList();
        }


        function closeTagModal() {
            document.getElementById("tagModal").style.display = "none";
        }


        function loadTagsList() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(tags => {
                    const tagsList = document.getElementById("tagsList");
                    tagsList.innerHTML = '<div class="tags-list">';
                   
                    tags.forEach(tag => {
                        tagsList.innerHTML += `
                            <div class="tag-item">
                                <span class="tag-preview" style="background-color: ${tag.color}">${tag.name}</span>
                                <div>
                                    <button onclick="editTag(${tag.id})">Edit</button>
                                    <button onclick="deleteTag(${tag.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    tagsList.innerHTML += '</div>';
                    updateTagSelectors(tags);
                });
        }


        function editTag(tagId) {
            document.getElementById("tagModal").style.display = "none";
           
            fetch(`/api/tags/${tagId}`)
                .then(response => response.json())
                .then(tag => {
                    document.getElementById("editTagId").value = tagId;
                    document.getElementById("editTagName").value = tag.name;
                    document.getElementById("editTagColor").value = tag.color;
                    document.getElementById("editTagModal").style.display = "block";
                })
                .catch(error => alert('Error loading tag data'));
        }


        function closeEditTagModal() {
            document.getElementById("editTagModal").style.display = "none";
            document.getElementById("tagModal").style.display = "block";
        }


        function saveTagEdit() {
            const id = document.getElementById("editTagId").value;
            const name = document.getElementById("editTagName").value;
            const color = document.getElementById("editTagColor").value;

            if (!name) {
                alert("Tag name is required!");
                return;
            }

            fetch(`/api/tags/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    color: color
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditTagModal();
                    loadTagsList();
                    loadTags();
                } else {
                    alert('Error updating tag: ' + data.error);
                }
            })
            .catch(error => alert('Error updating tag'));
        }


        function deleteTag(tagId) {
            if (confirm('Are you sure you want to delete this tag?')) {
                fetch(`/api/tags/${tagId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTagsList();
                    } else {
                        alert('Error deleting tag: ' + data.error);
                    }
                })
                .catch(error => alert('Error deleting tag'));
            }
        }


        function applyFilters() {
            const projectId = document.getElementById('projectFilter').value;
            
            if (projectId) {
                loadBoard(projectId);
            } else {
                document.querySelector('.kanban-board').innerHTML = '<p></p>';
            }
        }

        function loadBoard(projectId) {
            // Primeiro, carregue as fases do projeto
            fetch(`/api/projects/${projectId}/phases`)
                .then(response => response.json())
                .then(phases => {
                    const board = document.querySelector('.kanban-board');
                    board.innerHTML = '';
                    
                    // Crie uma coluna para cada fase
                    phases.forEach(phase => {
                        const column = document.createElement('div');
                        column.className = 'kanban-column';
                        column.id = `phase_${phase.id}`;
                        column.setAttribute('ondrop', 'drop(event)');
                        column.setAttribute('ondragover', 'allowDrop(event)');
                        
                        column.innerHTML = `
                            <div class="column-header">
                                <h2>${phase.name}</h2>
                                <button class="add-card-button" onclick="openNewCardModal(${phase.id})" title="Add new card">+</button>
                            </div>
                        `;
                        
                        board.appendChild(column);
                    });
                    
                    // Depois de criar as colunas, carregue os cards
                    return fetch(`/api/cards?project_id=${projectId}`);
                })
                .then(response => response.json())
                .then(cards => {
                    // Adicione cada card na coluna correta
                    cards.forEach(card => {
                        const column = document.getElementById(`phase_${card.phase_id}`);
                        if (column) {
                            const cardElement = createCard(
                                card.id,
                                card.title,
                                card.description,
                                card.tempo,
                                card.team?.name,
                                card.tags,
                                card.project_id,
                                card.deadline,
                                card.users
                            );
                            column.appendChild(cardElement);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading board');
                });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const projectFilter = document.getElementById('projectFilter');
            if (projectFilter) {
                projectFilter.addEventListener('change', applyFilters);
            }
        });


        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectFilter = document.getElementById("projectFilter");
                    const newCardProject = document.getElementById("newCardProject");
                    const options = '<option value="">All Projects</option>' + 
                        projects.map(project => `
                            <option value="${project.id}">${project.name}</option>`
                        ).join('');
                    
                    projectFilter.innerHTML = options;
                    newCardProject.innerHTML = options.replace('All Projects', 'Select Project');
                    
                    applyFilters();
                });
        }


        function showModal(modalId) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
            document.getElementById(modalId).style.display = "block";
        }


        function openTagModal() {
            showModal('tagModal');
            loadTagsList();
        }


        function openProjectModal() {
            showModal('projectModal');
            loadProjectsList();
        }


        window.onload = function() {
            loadTags();
            loadProjects();
            applyFilters();
        };


        loadTags();


        loadTeams();


        {% for card in cards %}
            document.getElementById("{{ card.column }}").appendChild(
                createCard(
                    "{{ card.id }}",
                    "{{ card.title }}",
                    "{{ card.description }}",
                    "{{ card.tempo }}",
                    "{{ card.team.name if card.team else '' }}",
                    [
                        {% for tag in card.tags %}
                            {
                                id: {{ tag.id }},
                                name: "{{ tag.name }}",
                                color: "{{ tag.color }}"
                            }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    "{{ card.project_id }}",
                    "{{ card.deadline }}",
                    {{ card.users | tojson }}
                )
            );
        {% endfor %}


        function openProjectModal() {
            document.getElementById("projectModal").style.display = "block";
            loadProjectsList();
        }


        function closeProjectModal() {
            document.getElementById("projectModal").style.display = "none";
        }


        function createProject() {
            const name = document.getElementById("projectName").value;
            const description = document.getElementById("projectDescription").value;
            const phases = getPhases();

            if (!name) {
                alert('Project name is required!');
                return;
            }

            if (phases.length === 0) {
                alert('At least one phase is required!');
                return;
            }

            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    description,
                    phases
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeProjectModal();
                    loadProjects();
                } else {
                    alert('Error creating project: ' + data.error);
                }
            });
        }


        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectFilter = document.getElementById("projectFilter");
                    const newCardProject = document.getElementById("newCardProject");
                    const options = '<option value="">All Projects</option>' + 
                        projects.map(project => `
                            <option value="${project.id}">${project.name}</option>`
                        ).join('');
                    
                    projectFilter.innerHTML = options;
                    newCardProject.innerHTML = options.replace('All Projects', 'Select Project');
                });
        }


        function loadProjectsList() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectsList = document.getElementById("projectsList");
                    projectsList.innerHTML = '';
                    
                    projects.forEach(project => {
                        projectsList.innerHTML += `
                            <div class="project-item">
                                <span>${project.name}</span>
                                <div>
                                    <button onclick="editProject(${project.id})">Edit</button>
                                    <button onclick="deleteProject(${project.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                });
        }


        function searchCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const cards = document.querySelectorAll('.kanban-card');
            let visibleCount = 0;

            cards.forEach(card => {
                if (!searchTerm) {
                    card.style.display = 'block';
                    card.querySelectorAll('.highlight').forEach(el => {
                        el.outerHTML = el.textContent;
                    });
                    visibleCount++;
                    return;
                }

                // Coleta todo o conteúdo pesquisável do card
                const searchableContent = [
                    card.querySelector('h3')?.textContent || '', // título
                    card.getAttribute('data-description') || '', // descrição
                    card.querySelector('p')?.textContent || '', // tempo
                    card.querySelector('.card-deadline')?.textContent || '', // deadline
                    card.querySelector('.team-tag')?.textContent || '', // time
                    Array.from(card.querySelectorAll('.card-tag')).map(tag => tag.textContent).join(' '), // tags
                    Array.from(card.querySelectorAll('.user-tag')).map(user => user.textContent).join(' ') // usuários
                ].join(' ').toLowerCase();

                const isVisible = searchableContent.includes(searchTerm);
                card.style.display = isVisible ? 'block' : 'none';

                if (isVisible) {
                    visibleCount++;
                    highlightSearchTerm(card, searchTerm);
                }
            });

            updateSearchPlaceholder(visibleCount);
        }

        function highlightSearchTerm(card, searchTerm) {
            // Remove destaques anteriores
            card.querySelectorAll('.highlight').forEach(el => {
                el.outerHTML = el.textContent;
            });

            // Função para adicionar destaque
            const addHighlight = (element) => {
                if (element && element.textContent) {
                    element.innerHTML = element.textContent.replace(
                        new RegExp(searchTerm, 'gi'),
                        match => `<span class="highlight">${match}</span>`
                    );
                }
            };

            // Aplica destaque aos elementos
            addHighlight(card.querySelector('h3')); // título
            addHighlight(card.querySelector('p')); // descrição/tempo
        }

        function updateSearchPlaceholder(count) {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput.value) {
                searchInput.placeholder = 'Buscar por título, descrição, tags, usuários...';
            } else {
                searchInput.placeholder = count > 0 
                    ? `${count} resultados encontrados` 
                    : 'Nenhum resultado encontrado';
            }
        }

        // Função de debounce para melhorar a performance
        const debounce = (func, wait) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        // Aplica o debounce à função de busca
        const debouncedSearch = debounce(searchCards, 300);

        // Remove todos os outros event listeners de busca e adiciona apenas este
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                // Remove event listeners antigos
                searchInput.replaceWith(searchInput.cloneNode(true));
                
                // Adiciona o novo event listener
                document.getElementById('searchInput').addEventListener('input', debouncedSearch);
            }
        });


        document.getElementById('searchInput').placeholder = 'Buscar por título, descrição, tags, usuários...';


        document.addEventListener('click', function(e) {
            if (e.target.matches('.add-card-button')) {
                openNewCardModal(e.target.closest('.kanban-column').id);
            }
        });


        function toggleConfigModal() {
            const modal = document.getElementById('configModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }

        function saveConfig() {
            // Aqui você pode adicionar a lógica para salvar as configurações
            alert('Configurações salvas!');
            toggleConfigModal();
        }

        // Fechar o modal quando clicar fora dele
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('configModal');
            const configButton = event.target.closest('.config-button');
            const modalContent = event.target.closest('.config-modal');
            
            if (!configButton && !modalContent && modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });

        function editProject(projectId) {
            fetch(`/api/projects/${projectId}`)
                .then(response => response.json())
                .then(project => {
                    document.getElementById("editProjectId").value = projectId;
                    document.getElementById("editProjectName").value = project.name;
                    document.getElementById("editProjectDescription").value = project.description || '';
                    document.getElementById("editProjectModal").style.display = "block";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading project data');
                });
        }

        function saveProjectEdit() {
            const id = document.getElementById("editProjectId").value;
            const name = document.getElementById("editProjectName").value;
            const description = document.getElementById("editProjectDescription").value;

            if (!name) {
                alert("Project name is required!");
                return;
            }

            fetch(`/api/projects/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditProjectModal();
                    loadProjectsList();
                    loadProjects();
                } else {
                    alert('Error updating project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating project');
            });
        }

        function closeEditProjectModal() {
            document.getElementById("editProjectModal").style.display = "none";
        }

        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This will also delete all associated cards.')) {
                return;
            }

            fetch(`/api/projects/${projectId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadProjectsList();
                    loadProjects();
                } else {
                    alert('Error deleting project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting project');
            });
        }

        function loadProjectsList() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectsList = document.getElementById("projectsList");
                    projectsList.innerHTML = '';
                    
                    projects.forEach(project => {
                        projectsList.innerHTML += `
                            <div class="project-item">
                                <div class="project-info">
                                    <span class="project-name">${project.name}</span>
                                    <span class="project-description">${project.description || ''}</span>
                                </div>
                                <div class="project-actions">
                                    <button onclick="editProject(${project.id})" class="edit-btn">Edit</button>
                                    <button onclick="deleteProject(${project.id})" class="delete-btn">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading projects list');
                });
        }

        function loadBoard(projectId) {
            if (!projectId) {
                document.querySelector('.kanban-board').innerHTML = '<p>Please select a project</p>';
                return;
            }

            fetch(`/api/projects/${projectId}/phases`)
                .then(response => response.json())
                .then(phases => {
                    const board = document.querySelector('.kanban-board');
                    board.innerHTML = '';
                    
                    phases.forEach(phase => {
                        const column = document.createElement('div');
                        column.className = 'kanban-column';
                        column.id = `phase_${phase.id}`;
                        column.setAttribute('ondrop', 'drop(event)');
                        column.setAttribute('ondragover', 'allowDrop(event)');
                        
                        column.innerHTML = `
                            <div class="column-header">
                                <h2>${phase.name}</h2>
                                <button class="add-card-button" onclick="openNewCardModal(${phase.id})" title="Add new card">+</button>
                            </div>
                        `;
                        
                        board.appendChild(column);
                    });
                    
                    // Recarregar os cards do projeto
                    loadProjectCards(projectId);
                });
        }

        function loadProjectCards(projectId) {
            fetch(`/api/cards?project_id=${projectId}`)
                .then(response => response.json())
                .then(cards => {
                    // Limpar todos os cards existentes
                    document.querySelectorAll('.kanban-card').forEach(card => card.remove());
                    
                    // Adicionar os cards nas colunas corretas
                    cards.forEach(card => {
                        const column = document.getElementById(`phase_${card.phase_id}`);
                        if (column) {
                            column.appendChild(createCard(
                                card.id,
                                card.title,
                                card.description,
                                card.tempo,
                                card.team?.name,
                                card.tags,
                                card.project_id,
                                card.deadline,
                                card.users
                            ));
                        }
                    });
                });
        }

        // Atualizar o event listener do filtro de projeto
        document.getElementById('projectFilter').addEventListener('change', function(e) {
            const projectId = e.target.value;
            if (projectId) {
                loadBoard(projectId);
            }
        });

        function addPhaseInput() {
            const phasesList = document.getElementById('phasesList');
            const phaseDiv = document.createElement('div');
            phaseDiv.className = 'phase-input';
            phaseDiv.draggable = true;
            phaseDiv.innerHTML = `
                <span class="drag-handle">⋮</span>
                <input type="text" class="phase-name" placeholder="Phase Name" required>
                <button class="remove-phase" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Adicionar eventos de drag and drop
            phaseDiv.ondragstart = handleDragStart;
            phaseDiv.ondragover = handleDragOver;
            phaseDiv.ondrop = handleDrop;
            
            phasesList.appendChild(phaseDiv);
        }

        // Funções para drag and drop das fases
        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', '');
        }

        function handleDragOver(e) {
            e.preventDefault();
            const draggingElement = document.querySelector('.dragging');
            const container = document.getElementById('phasesList');
            const siblings = [...container.querySelectorAll('.phase-input:not(.dragging)')];
            
            const nextSibling = siblings.find(sibling => {
                const rect = sibling.getBoundingClientRect();
                return e.clientY < rect.top + rect.height / 2;
            });
            
            if (nextSibling) {
                container.insertBefore(draggingElement, nextSibling);
            } else {
                container.appendChild(draggingElement);
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            document.querySelector('.dragging').classList.remove('dragging');
        }

        // Função atualizada para criar projeto
        function createProject() {
            const name = document.getElementById('projectName').value.trim();
            const description = document.getElementById('projectDescription').value.trim();
            const phaseInputs = document.querySelectorAll('.phase-name');
            const phases = Array.from(phaseInputs)
                .map(input => ({
                    name: input.value.trim()
                }))
                .filter(phase => phase.name !== '');

            if (!name) {
                alert('Project name is required!');
                return;
            }

            if (phases.length === 0) {
                alert('At least one phase is required!');
                return;
            }

            // Verificar se todas as fases têm nome
            if (phases.some(phase => !phase.name)) {
                alert('All phases must have a name!');
                return;
            }

            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    description,
                    phases
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeProjectModal();
                    loadProjects();
                    // Se houver um projeto selecionado, recarregue o board
                    const selectedProject = document.getElementById('projectFilter').value;
                    if (selectedProject) {
                        loadBoard(selectedProject);
                    }
                } else {
                    alert('Error creating project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating project');
            });
        }

        function loadPhasesByProject(projectId) {
            if (!projectId) {
                document.getElementById('newCardPhase').innerHTML = '<option value="">Select Phase</option>';
                return Promise.resolve();
            }

            return fetch(`/api/projects/${projectId}/phases`)
                .then(response => response.json())
                .then(phases => {
                    const phaseSelect = document.getElementById('newCardPhase');
                    phaseSelect.innerHTML = '<option value="">Select Phase</option>';
                    phases.forEach(phase => {
                        phaseSelect.innerHTML += `
                            <option value="${phase.id}">${phase.name}</option>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error loading phases:', error);
                    alert('Error loading project phases');
                });
        }

        // Modifique a função openNewCardModal
        async function openNewCardModal(phase_id) {
            try {
                const modal = document.getElementById("createModal");
                const newCardProject = document.getElementById("newCardProject");
                const selectedProjectId = document.getElementById("projectFilter").value;

                // Mostrar modal
                modal.style.display = "block";

                // Limpar campos
                document.getElementById("newCardTitle").value = "";
                document.getElementById("newCardDescription").value = "";
                document.getElementById("newCardTempo").value = "";
                document.getElementById("newCardDeadline").value = "";

                // Carregar dados (usuários e tags)
                const { users, tags } = await loadModalData();

                // Atualizar select de usuários
                const userSelect = document.getElementById('newCardUsers');
                userSelect.innerHTML = users.map(user => 
                    `<option value="${user.id}">${user.name}</option>`
                ).join('');

                // Atualizar tags
                const tagsContainer = document.getElementById('newCardTags');
                if (tagsContainer) {
                    tagsContainer.innerHTML = tags.map(tag => `
                        <div class="tag-checkbox">
                            <input type="checkbox" id="new_tag_${tag.id}" value="${tag.id}">
                            <label for="new_tag_${tag.id}" style="background-color: ${tag.color}">${tag.name}</label>
                        </div>
                    `).join('');
                }

                // Configurar projeto e fases
                if (selectedProjectId) {
                    newCardProject.value = selectedProjectId;
                    newCardProject.disabled = true;
                    
                    // Carregar fases do projeto
                    await loadPhasesByProject(selectedProjectId);
                    
                    // Selecionar fase se fornecida
                    if (phase_id) {
                        const phaseValue = typeof phase_id === 'string' ? 
                            phase_id.replace('phase_', '') : 
                            phase_id.toString();
                            
                        document.getElementById("newCardPhase").value = phaseValue;
                    }
                }
            } catch (error) {
                console.error('Error opening modal:', error);
                // Melhor tratamento de erro - mais informativo
                alert('Error loading card creation form. Details: ' + error.message);
            }
        }

        // Nova função para carregar usuários e tags
        async function loadModalData() {
            try {
                // Carregar usuários
                const usersResponse = await fetch('/api/teams');
                const users = await usersResponse.json();
                
                // Carregar tags
                const tagsResponse = await fetch('/api/tags');
                const tags = await tagsResponse.json();
                
                return { users, tags };
            } catch (error) {
                console.error('Error loading modal data:', error);
                throw error;
            }
        }

        function filterByProject(projectId) {
            // Use replaceState para atualizar a URL sem recarregar a página
            const url = new URL(window.location.href);
            if (projectId) {
                url.searchParams.set('project', projectId);
            } else {
                url.searchParams.delete('project');
            }
            history.replaceState(null, '', url);
            
            // Fazer requisição AJAX para buscar os dados filtrados
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const newDoc = parser.parseFromString(html, 'text/html');
                    
                    // Atualiza apenas o conteúdo do kanban-board
                    document.querySelector('.kanban-board').innerHTML = 
                        newDoc.querySelector('.kanban-board').innerHTML;
                        
                    // Re-inicializa o drag and drop se necessário
                    initDragAndDrop();
                });
        }

        // Função para inicializar drag and drop (se você estiver usando)
        function initDragAndDrop() {
            // Seu código de inicialização do drag and drop aqui
        }
    </script>
    <footer class="footer">
        © 2024 GrittiCorp. All rights reserved.
    </footer>

    <!-- Scripts -->
    <script>
// Função simplificada de busca
function setupSearch() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return;

    // Remove event listeners anteriores
    const newSearchInput = searchInput.cloneNode(true);
    searchInput.parentNode.replaceChild(newSearchInput, searchInput);

    let timeout = null;
    newSearchInput.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            const searchTerm = this.value.toLowerCase().trim();
            const cards = document.querySelectorAll('.kanban-card');
            let found = 0;

            cards.forEach(card => {
                // Reset highlights
                card.querySelectorAll('.highlight').forEach(el => {
                    el.outerHTML = el.textContent;
                });

                if (!searchTerm) {
                    card.style.display = 'block';
                    found++;
                    return;
                }

                // Busca em todos os campos do card
                const content = [
                    card.querySelector('h3')?.textContent,           // título
                    card.getAttribute('data-description'),           // descrição
                    card.querySelector('p')?.textContent,           // tempo
                    card.querySelector('.card-deadline')?.textContent,  // deadline
                    ...Array.from(card.querySelectorAll('.card-tag')).map(tag => tag.textContent),    // tags
                    ...Array.from(card.querySelectorAll('.user-tag')).map(user => user.textContent)   // usuários
                ].filter(Boolean).join(' ').toLowerCase();

                const isMatch = content.includes(searchTerm);
                card.style.display = isMatch ? 'block' : 'none';
                
                if (isMatch) {
                    found++;
                    // Highlight matches
                    highlightText(card, searchTerm);
                }
            });

            // Update placeholder
            this.placeholder = searchTerm ? 
                `${found} resultado${found !== 1 ? 's' : ''} encontrado${found !== 1 ? 's' : ''}` : 
                'Buscar por título, descrição, tags, usuários...';
        }, 300);
    });
}

function highlightText(card, term) {
    const elements = [
        card.querySelector('h3'),
        card.querySelector('p'),
        ...card.querySelectorAll('.card-tag'),
        ...card.querySelectorAll('.user-tag')
    ].filter(Boolean);

    elements.forEach(el => {
        if (el.textContent.toLowerCase().includes(term)) {
            el.innerHTML = el.textContent.replace(
                new RegExp(`(${term})`, 'gi'),
                '<span class="highlight">$1</span>'
            );
        }
    });
}

// Inicializa a busca quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', setupSearch);
</script>

<style>
.highlight {
    background-color: rgba(138, 5, 190, 0.2);
    border-radius: 2px;
    padding: 0 2px;
}

#searchInput::placeholder {
    color: var(--text-secondary);
    transition: color 0.3s ease;
}
</style>
</body>
</html>