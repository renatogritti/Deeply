<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <meta name="theme-color" content="#8A05BE">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"></noscript>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <svg class="logo" viewBox="0 0 24 24">
                <path d="M4 3C2.89 3 2 3.89 2 5V19C2 20.11 2.89 21 4 21H20C21.11 21 22 20.11 22 19V5C22 3.89 21.11 3 20 3H4M4 5H20V19H4V5M6 7V17H10V7H6M12 7V11H16V7H12M12 13V17H16V13H12Z"/>
            </svg>
            <h1>Kanban Board</h1>
        </div>
        
        <div class="header-content">
            <div class="search-box">
                <svg class="search-icon" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                </svg>
                <input type="text" id="searchInput" placeholder="Buscar cards...">
            </div>

            <div class="project-filter">
                <select id="projectFilter" onchange="applyFilters()">
                    <option value="">All Projects</option>
                    {% for project in projects %}
                        <option value="{{ project.id }}">{{ project.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <button class="sidebar-button" onclick="openProjectModal()">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
            </svg>
            <span>Manage Projects</span>
        </button>
        
        <button class="sidebar-button" onclick="openTeamModal()">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z"/>
            </svg>
            <span>Manage Teams</span>
        </button>
        
        <button class="sidebar-button" onclick="openTagModal()">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M5.5,7A1.5,1.5 0 0,1 4,5.5A1.5,1.5 0 0,1 5.5,4A1.5,1.5 0 0,1 7,5.5A1.5,1.5 0 0,1 5.5,7M21.41,11.58L12.41,2.58C12.05,2.22 11.55,2 11,2H4C2.89,2 2,2.89 2,4V11C2,11.55 2.22,12.05 2.59,12.41L11.58,21.41C11.95,21.77 12.45,22 13,22C13.55,22 14.05,21.77 14.41,21.41L21.41,14.41C21.78,14.05 22,13.55 22,13C22,12.44 21.77,11.94 21.41,11.58Z"/>
            </svg>
            <span>Manage Tags</span>
        </button>
        
        <button class="sidebar-button" onclick="openShareModal()">
            <svg viewBox="0 0 24 24">
                <path fill="currentColor" d="M18,16.08C17.24,16.08 16.56,16.38 16.04,16.85L8.91,12.7C8.96,12.47 9,12.24 9,12C9,11.76 8.96,11.53 8.91,11.3L15.96,7.19C16.5,7.69 17.21,8 18,8A3,3 0 0,0 21,5A3,3 0 0,0 18,2A3,3 0 0,0 15,5C15,5.24 15.04,5.47 15.09,5.7L8.04,9.81C7.5,9.31 6.79,9 6,9A3,3 0 0,0 3,12A3,3 0 0,0 6,15C6.79,15 7.5,14.69 8.04,14.19L15.16,18.34C15.11,18.55 15.08,18.77 15.08,19C15.08,20.61 16.39,21.91 18,21.91C19.61,21.91 20.92,20.61 20.92,19A2.92,2.92 0 0,0 18,16.08Z"/>
            </svg>
            <span>Share</span>
        </button>
    </div>

    <!-- ...rest of the code... -->

    <div class="frames-container">
        <div class="board-frame">
            <div class="kanban-board">
                <!-- As colunas serão geradas dinamicamente pelo JavaScript -->
            </div>
        </div>
    </div>


    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>Edit Card</h3>
            <select id="editCardProject" required>
                <option value="">Select Project</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
            <input type="text" id="editCardTitle" placeholder="Title">
            <input type="text" id="editCardDescription" placeholder="Description">
            <input type="text" id="editCardTempo" placeholder="Tempo">
            <input type="date" id="editCardDeadline" placeholder="Deadline (opcional)">
            <select id="editCardTeam" style="display: none">
                <option value="">Select Team</option>
                {% for team in teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                {% endfor %}
            </select>
            <div class="tags-container">
                <label>Tags:</label>
                <div id="editCardTags" class="tags-selection">
                    <!-- Tags will be added here -->
                </div>
            </div>
            <div class="users-container">
                <label>Assigned Users (Ctrl+Click for multiple):</label>
                <select id="editCardUsers" multiple size="4">
                    {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-buttons">
                <button onclick="saveCardEdit()">Save</button>
                <button onclick="deleteCard()" class="delete-button">Delete</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
            <input type="hidden" id="editCardId">
        </div>
    </div>


    <!-- Modifique o createModal, adicione o select de projeto antes do select de time -->
    <div id="createModal" class="modal">
        <div class="modal-content">
            <h3>Create New Card</h3>
            <select id="newCardProject" required onchange="loadPhasesByProject(this.value)">
                <option value="">Select Project</option>
                {% for project in projects %}
                    <option value="{{ project.id }}">{{ project.name }}</option>
                {% endfor %}
            </select>
            <input type="text" id="newCardTitle" placeholder="Title">
            <input type="text" id="newCardDescription" placeholder="Description">
            <input type="text" id="newCardTempo" placeholder="Tempo (e.g., 2h)">
            <input type="date" id="newCardDeadline" placeholder="Deadline (opcional)">
            <select id="newCardPhase" required>
                <option value="">Select Phase</option>
            </select>
            <select id="newCardTeam" style="display: none">
                <option value="">Select Team</option>
                {% for team in teams %}
                    <option value="{{ team.id }}">{{ team.name }}</option>
                {% endfor %}
            </select>
            <div class="tags-container">
                <label>Tags:</label>
                <div id="newCardTags" class="tags-selection">
                    <!-- Tags will be added here -->
                </div>
            </div>
            <div class="users-container">
                <label>Assigned Users (Ctrl+Click for multiple):</label>
                <select id="newCardUsers" multiple size="4">
                    {% for team in teams %}
                        <option value="{{ team.id }}">{{ team.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="createNewCard()">Create</button>
            <button onclick="closeCreateModal()">Cancel</button>
        </div>
    </div>


    <!-- Modifique o Team Management Modal -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <h3>Manage Users</h3>
            <input type="text" id="teamName" placeholder="Nome do Usuário" required>
            <input type="email" id="teamDescription" placeholder="Email" required>
            <button onclick="createTeam()">Add User</button>
            <button onclick="closeTeamModal()">Close</button>
            <div id="teamsList">
                <!-- Users will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modifique o Edit Team Modal -->
    <div id="editTeamModal" class="modal">
        <div class="modal-content">
            <h3>Edit User</h3>
            <input type="text" id="editTeamName" placeholder="Nome do Usuário" required>
            <input type="email" id="editTeamDescription" placeholder="Email" required>
            <input type="hidden" id="editTeamId">
            <button onclick="saveTeamEdit()">Save</button>
            <button onclick="closeEditTeamModal()">Cancel</button>
        </div>
    </div>


    <!-- Add the Tag Management Modal -->
    <div id="tagModal" class="modal">
        <div class="modal-content">
            <h3>Manage Tags</h3>
            <input type="text" id="tagName" placeholder="Tag Name">
            <input type="color" id="tagColor" value="#1a73e8">
            <button onclick="createTag()">Add Tag</button>
            <button onclick="closeTagModal()">Close</button>
            <div id="tagsList">
                <!-- Tags will be listed here -->
            </div>
        </div>
    </div>


    <!-- Adicionar modal de edição de tag -->
    <div id="editTagModal" class="modal">
        <div class="modal-content">
            <h3>Edit Tag</h3>
            <input type="text" id="editTagName" placeholder="Tag Name">
            <input type="color" id="editTagColor">
            <input type="hidden" id="editTagId">
            <button onclick="saveTagEdit()">Save</button>
            <button onclick="closeEditTagModal()">Cancel</button>
        </div>
    </div>

    <!-- Adicione o modal de projetos -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <h3>Manage Project</h3>
            <input type="text" id="projectName" placeholder="Project Name">
            <input type="text" id="projectDescription" placeholder="Project Description">
            
            <div class="phases-container">
                <h4>Phases</h4>
                <div id="phasesList">
                    <!-- Phases will be added here -->
                </div>
                <button onclick="addPhaseInput()">Add Phase</button>
            </div>
            
            <button onclick="createProject()">Add Project</button>
            <button onclick="closeProjectModal()">Close</button>
        </div>
    </div>

    <!-- Adicione o modal de compartilhamento -->
    <div id="shareModal" class="modal">
        <div class="modal-content">
            <h3>Compartilhar Kanban</h3>
            <input type="email" id="shareEmail" placeholder="Digite o email para compartilhar">
            <div class="share-buttons">
                <button onclick="sendShareEmail()">Enviar</button>
                <button onclick="closeShareModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Adicione este modal após o projectModal -->
    <div id="editProjectModal" class="modal">
        <div class="modal-content">
            <h3>Edit Project</h3>
            <input type="text" id="editProjectName" placeholder="Project Name">
            <input type="text" id="editProjectDescription" placeholder="Project Description">
            <input type="hidden" id="editProjectId">
            <div class="modal-buttons">
                <button onclick="saveProjectEdit()">Save</button>
                <button onclick="closeEditProjectModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        function allowDrop(event) {
            event.preventDefault();
        }


        function drag(event) {
            event.dataTransfer.setData("text", event.target.id);
        }


        function createCard(id, title, description, tempo, team_name, tags = [], project_id, deadline = null, users = []) {
            var card = document.createElement("div");
            card.className = "kanban-card";
            card.id = id;
            card.draggable = true;
            card.ondragstart = drag;
            card.ondblclick = editCard;
            card.setAttribute('data-project-id', project_id);
            card.setAttribute('data-description', description);

            var cardTitle = document.createElement("h3");
            cardTitle.textContent = title;
            card.appendChild(cardTitle);

            var cardTempo = document.createElement("p");
            cardTempo.textContent = "Tempo: " + tempo;
            card.appendChild(cardTempo);

            if (deadline) {
                var cardDeadline = document.createElement("p");
                cardDeadline.textContent = "Deadline: " + new Date(deadline).toLocaleDateString();
                cardDeadline.className = "card-deadline";
                card.appendChild(cardDeadline);
            }

            if (team_name) {
                var teamTag = document.createElement("div");
                teamTag.className = "team-tag";
                teamTag.textContent = team_name;
                card.appendChild(teamTag);
            }

            if (tags && tags.length > 0) {
                var tagsContainer = document.createElement("div");
                tagsContainer.className = "card-tags";
                tags.forEach(tag => {
                    var tagElement = document.createElement("span");
                    tagElement.className = "card-tag";
                    tagElement.textContent = tag.name;
                    tagElement.style.backgroundColor = tag.color;
                    tagsContainer.appendChild(tagElement);
                });
                card.appendChild(tagsContainer);
            }

            if (users && users.length > 0) {
                var usersContainer = document.createElement("div");
                usersContainer.className = "card-users";
                users.forEach(user => {
                    var userTag = document.createElement("div");
                    userTag.className = "user-tag";
                    userTag.textContent = user.name;
                    usersContainer.appendChild(userTag);
                });
                card.appendChild(usersContainer);
            }

            return card;
        }

        function openNewCardModal(phase_id) {
            const selectedProjectId = document.getElementById("projectFilter").value;
            document.getElementById("createModal").style.display = "block";
            const newCardProject = document.getElementById("newCardProject");
            
            if (selectedProjectId) {
                newCardProject.value = selectedProjectId;
                newCardProject.disabled = true;
                loadPhasesByProject(selectedProjectId).then(() => {
                    document.getElementById("newCardPhase").value = phase_id;
                });
            } else {
                newCardProject.disabled = false;
                newCardProject.value = "";
                document.getElementById('newCardPhase').innerHTML = '<option value="">Select Phase</option>';
            }
        }


        function closeCreateModal() {
            document.getElementById("createModal").style.display = "none";
            document.getElementById("newCardTitle").value = "";
            document.getElementById("newCardDescription").value = "";
            document.getElementById("newCardTempo").value = "";
            document.getElementById("newCardProject").disabled = false;
        }


        function closeModal() {
            document.getElementById("editModal").style.display = "none";
        }


        function createNewCard() {
            const title = document.getElementById("newCardTitle").value;
            const description = document.getElementById("newCardDescription").value;
            const tempo = document.getElementById("newCardTempo").value;
            const deadline = document.getElementById("newCardDeadline").value;
            const phase_id = document.getElementById("newCardPhase").value;
            const teamId = document.getElementById("newCardTeam").value;
            const projectId = document.getElementById("newCardProject").value;
            const selectedTags = Array.from(document.querySelectorAll('#newCardTags input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.value));
            const selectedUsers = Array.from(document.getElementById('newCardUsers').selectedOptions)
                .map(option => parseInt(option.value));
            const id = "card" + Date.now();

            if (!title || !description || !tempo) {
                alert("Please fill in all required fields!");
                return;
            }

            if (!projectId) {
                alert("Please select a project!");
                return;
            }

            if (!phase_id) {
                alert("Please select a phase!");
                return;
            }

            fetch('/api/cards', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    id: id,
                    title: title,
                    description: description,
                    tempo: tempo,
                    deadline: deadline || null,
                    phase_id: phase_id,
                    team_id: teamId || null,
                    project_id: projectId,
                    tag_ids: selectedTags,
                    user_ids: selectedUsers
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const teamSelect = document.getElementById("newCardTeam");
                    const teamName = teamId ? teamSelect.options[teamSelect.selectedIndex].text : '';
                    
                    const card = createCard(
                        id, 
                        title, 
                        description, 
                        tempo, 
                        teamName, 
                        data.card.tags,
                        projectId, 
                        deadline, 
                        data.card.users
                    );

                    // Adiciona o card na coluna correta usando o phase_id
                    document.getElementById(`phase_${phase_id}`).appendChild(card);
                    
                    closeCreateModal();
                    
                    document.querySelectorAll('#newCardTags input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = false;
                    });
                } else {
                    alert('Error creating card: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating card');
            });
        }


        function editCard(event) {
            const card = event.currentTarget;
            const modal = document.getElementById("editModal");
            
            const title = card.querySelector("h3").textContent;
            const description = card.getAttribute('data-description');
            const tempo = card.querySelector("p").textContent.replace("Tempo: ", "");
            const deadlineEl = card.querySelector(".card-deadline");
            const teamTag = card.querySelector(".team-tag");
            const projectId = card.getAttribute('data-project-id');

            document.getElementById("editCardId").value = card.id;
            document.getElementById("editCardProject").value = projectId;
            document.getElementById("editCardTitle").value = title;
            document.getElementById("editCardDescription").value = description;
            document.getElementById("editCardTempo").value = tempo;
            document.getElementById("editCardProject").disabled = true;

            if (deadlineEl) {
                const deadlineText = deadlineEl.textContent.replace("Deadline: ", "");
                const parts = deadlineText.split('/');
                const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                document.getElementById("editCardDeadline").value = formattedDate;
            } else {
                document.getElementById("editCardDeadline").value = "";
            }

            const teamSelect = document.getElementById("editCardTeam");
            if (teamTag) {
                const teamName = teamTag.textContent;
                Array.from(teamSelect.options).forEach(option => {
                    if (option.text === teamName) {
                        option.selected = true;
                    }
                });
            } else {
                teamSelect.value = "";
            }

            // Limpar seleções anteriores
            document.querySelectorAll('#editCardTags input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            document.querySelectorAll('#editCardUsers option').forEach(option => {
                option.selected = false;
            });

            fetch(`/api/cards/${card.id}`)
                .then(response => response.json())
                .then(data => {
                    // Atualizar tags
                    const cardTags = data.tags || [];
                    const checkboxes = document.querySelectorAll('#editCardTags input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = cardTags.some(tag => tag.id === parseInt(checkbox.value));
                    });

                    // Atualizar usuários
                    const userSelect = document.getElementById('editCardUsers');
                    const cardUsers = data.users || [];
                    Array.from(userSelect.options).forEach(option => {
                        option.selected = cardUsers.some(user => user.id === parseInt(option.value));
                    });
                });

            modal.style.display = "block";
        }


        function saveCardEdit() {
            const id = document.getElementById("editCardId").value;
            const card = document.getElementById(id);
            const data = {
                title: document.getElementById("editCardTitle").value,
                description: document.getElementById("editCardDescription").value,
                tempo: document.getElementById("editCardTempo").value,
                deadline: document.getElementById("editCardDeadline").value,
                team_id: document.getElementById("editCardTeam").value || null,
                tag_ids: Array.from(document.querySelectorAll('#editCardTags input[type="checkbox"]:checked'))
                    .map(checkbox => parseInt(checkbox.value)),
                user_ids: Array.from(document.getElementById('editCardUsers').selectedOptions)
                    .map(option => parseInt(option.value))
            };

            fetch(`/api/cards/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const projectId = document.getElementById("editCardProject").value;
                    const teamId = document.getElementById("editCardTeam").value;
                    const teamName = teamId ? document.getElementById("editCardTeam").options[document.getElementById("editCardTeam").selectedIndex].text : null;

                    const updatedCard = createCard(
                        id,
                        document.getElementById("editCardTitle").value,
                        document.getElementById("editCardDescription").value,
                        document.getElementById("editCardTempo").value,
                        teamName,
                        data.card.tags,
                        projectId,
                        document.getElementById("editCardDeadline").value,
                        data.card.users
                    );

                    const currentCard = document.getElementById(id);
                    currentCard.innerHTML = updatedCard.innerHTML;
                    currentCard.className = updatedCard.className;
                    currentCard.draggable = true;
                    currentCard.ondragstart = drag;
                    currentCard.ondblclick = editCard;
                    currentCard.setAttribute('data-project-id', projectId);

                    closeModal();
                } else {
                    alert('Error updating card: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating card');
            });
        }


        function deleteCard() {
            const id = document.getElementById("editCardId").value;
            const card = document.getElementById(id);

            if (confirm('Are you sure you want to delete this card?')) {
                fetch(`/api/cards/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        card.remove();
                        closeModal();
                    } else {
                        alert('Error deleting card: ' + data.error);
                    }
                })
                .catch(error => alert('Error deleting card'));
            }
        }


        function drop(event) {
            event.preventDefault();
            const data = event.dataTransfer.getData("text");
            const card = document.getElementById(data);
            const newColumn = event.target.closest('.kanban-column');
           
            if (newColumn) {
                const phase_id = newColumn.id.replace('phase_', '');
                fetch(`/api/cards/${data}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phase_id: parseInt(phase_id)  // Atualizado: usar phase_id ao invés de column
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        newColumn.appendChild(card);
                    } else {
                        alert('Error moving card: ' + data.error);
                    }
                })
                .catch(error => alert('Error moving card'));
            }
        }


        function createTeam() {
            const name = document.getElementById("teamName").value.trim();
            const email = document.getElementById("teamDescription").value.trim();
            
            if (!name) {
                alert("Nome do usuário é obrigatório!");
                return;
            }

            if (!email) {
                alert("Email é obrigatório!");
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Por favor, insira um endereço de email válido!");
                return;
            }

            fetch('/api/teams', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("teamName").value = "";
                    document.getElementById("teamDescription").value = "";
                    loadTeams();
                    loadTeamsList();
                } else {
                    alert('Error creating user: ' + data.error);
                }
            });
        }


        function loadTeams() {
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    const teamSelect = document.getElementById("newCardTeam");
                    teamSelect.innerHTML = '<option value="">Select Team</option>';
                    teams.forEach(team => {
                        teamSelect.innerHTML += `<option value="${team.id}">${team.name}</option>`;
                    });
                });
        }


        function openTeamModal() {
            showModal('teamModal');
            loadTeamsList();
        }


        function closeTeamModal() {
            document.getElementById("teamModal").style.display = "none";
        }


        function loadTeamsList() {
            fetch('/api/teams')
                .then(response => response.json())
                .then(teams => {
                    const teamsList = document.getElementById("teamsList");
                    teamsList.innerHTML = '';
                   
                    teams.forEach(team => {
                        teamsList.innerHTML += `
                            <div class="team-item">
                                <div>
                                    <div>${team.name}</div>
                                    <div style="font-size: 0.8em; color: #666;">${team.description}</div>
                                </div>
                                <div>
                                    <button onclick="editTeam(${team.id})">Edit</button>
                                    <button onclick="deleteTeam(${team.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    const teamSelects = ['newCardTeam', 'editCardTeam'];
                    teamSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">Select User</option>';
                            teams.forEach(team => {
                                select.innerHTML += `<option value="${team.id}">${team.name}</option>`;
                            });
                        }
                    });
                });
        }


        function editTeam(teamId) {
            fetch(`/api/teams/${teamId}`)
                .then(response => response.json())
                .then(team => {
                    document.getElementById("editTeamId").value = teamId;
                    document.getElementById("editTeamName").value = team.name;
                    document.getElementById("editTeamDescription").value = team.description;
                    document.getElementById("editTeamModal").style.display = "block";
                })
                .catch(error => alert('Error loading team data'));
        }


        function closeEditTeamModal() {
            document.getElementById("editTeamModal").style.display = "none";
        }


        function saveTeamEdit() {
            const id = document.getElementById("editTeamId").value;
            const name = document.getElementById("editTeamName").value.trim();
            const email = document.getElementById("editTeamDescription").value.trim();

            if (!name) {
                alert("Nome do usuário é obrigatório!");
                return;
            }

            if (!email) {
                alert("Email é obrigatório!");
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert("Por favor, insira um endereço de email válido!");
                return;
            }

            fetch(`/api/teams/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: email
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadTeams();
                    loadTeamsList();
                    closeEditTeamModal();
                } else {
                    alert('Error updating team: ' + data.error);
                }
            })
            .catch(error => alert('Error updating team'));
        }


        function deleteTeam(teamId) {
            if (confirm('Are you sure you want to delete this team?')) {
                fetch(`/api/teams/${teamId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTeams();
                        loadTeamsList();
                    } else {
                        alert('Error deleting team: ' + data.error);
                    }
                })
                .catch(error => alert('Error deleting team'));
            }
        }


        function loadTags() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(tags => {
                    updateTagSelectors(tags);
                });
        }


        function createTag() {
            const name = document.getElementById("tagName").value;
            const color = document.getElementById("tagColor").value;

            if (!name) {
                alert("Tag name is required!");
                return;
            }

            fetch('/api/tags', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, color })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById("tagName").value = "";
                    loadTags();
                    loadTagsList();
                } else {
                    alert('Error creating tag: ' + data.error);
                }
            });
        }


        function updateTagSelectors(tags) {
            const containers = document.querySelectorAll('.tags-selection');
            containers.forEach(container => {
                container.innerHTML = tags.map(tag => `
                    <div class="tag-checkbox">
                        <input type="checkbox" id="tag_${tag.id}" value="${tag.id}">
                        <label for="tag_${tag.id}" style="background-color: ${tag.color}">${tag.name}</label>
                    </div>
                `).join('');
            });
        }


        function openTagModal() {
            showModal('tagModal');
            loadTagsList();
        }


        function closeTagModal() {
            document.getElementById("tagModal").style.display = "none";
        }


        function loadTagsList() {
            fetch('/api/tags')
                .then(response => response.json())
                .then(tags => {
                    const tagsList = document.getElementById("tagsList");
                    tagsList.innerHTML = '<div class="tags-list">';
                   
                    tags.forEach(tag => {
                        tagsList.innerHTML += `
                            <div class="tag-item">
                                <span class="tag-preview" style="background-color: ${tag.color}">${tag.name}</span>
                                <div>
                                    <button onclick="editTag(${tag.id})">Edit</button>
                                    <button onclick="deleteTag(${tag.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    tagsList.innerHTML += '</div>';
                    updateTagSelectors(tags);
                });
        }


        function editTag(tagId) {
            document.getElementById("tagModal").style.display = "none";
           
            fetch(`/api/tags/${tagId}`)
                .then(response => response.json())
                .then(tag => {
                    document.getElementById("editTagId").value = tagId;
                    document.getElementById("editTagName").value = tag.name;
                    document.getElementById("editTagColor").value = tag.color;
                    document.getElementById("editTagModal").style.display = "block";
                })
                .catch(error => alert('Error loading tag data'));
        }


        function closeEditTagModal() {
            document.getElementById("editTagModal").style.display = "none";
            document.getElementById("tagModal").style.display = "block";
        }


        function saveTagEdit() {
            const id = document.getElementById("editTagId").value;
            const name = document.getElementById("editTagName").value;
            const color = document.getElementById("editTagColor").value;

            if (!name) {
                alert("Tag name is required!");
                return;
            }

            fetch(`/api/tags/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    color: color
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditTagModal();
                    loadTagsList();
                    loadTags();
                } else {
                    alert('Error updating tag: ' + data.error);
                }
            })
            .catch(error => alert('Error updating tag'));
        }


        function deleteTag(tagId) {
            if (confirm('Are you sure you want to delete this tag?')) {
                fetch(`/api/tags/${tagId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTagsList();
                    } else {
                        alert('Error deleting tag: ' + data.error);
                    }
                })
                .catch(error => alert('Error deleting tag'));
            }
        }


        function applyFilters() {
            const projectId = document.getElementById('projectFilter').value;
            
            if (projectId) {
                loadBoard(projectId);
            } else {
                document.querySelector('.kanban-board').innerHTML = '<p>Please select a project</p>';
            }
        }

        function loadBoard(projectId) {
            // Primeiro, carregue as fases do projeto
            fetch(`/api/projects/${projectId}/phases`)
                .then(response => response.json())
                .then(phases => {
                    const board = document.querySelector('.kanban-board');
                    board.innerHTML = '';
                    
                    // Crie uma coluna para cada fase
                    phases.forEach(phase => {
                        const column = document.createElement('div');
                        column.className = 'kanban-column';
                        column.id = `phase_${phase.id}`;
                        column.setAttribute('ondrop', 'drop(event)');
                        column.setAttribute('ondragover', 'allowDrop(event)');
                        
                        column.innerHTML = `
                            <div class="column-header">
                                <h2>${phase.name}</h2>
                                <button class="add-card-button" onclick="openNewCardModal(${phase.id})" title="Add new card">+</button>
                            </div>
                        `;
                        
                        board.appendChild(column);
                    });
                    
                    // Depois de criar as colunas, carregue os cards
                    return fetch(`/api/cards?project_id=${projectId}`);
                })
                .then(response => response.json())
                .then(cards => {
                    // Adicione cada card na coluna correta
                    cards.forEach(card => {
                        const column = document.getElementById(`phase_${card.phase_id}`);
                        if (column) {
                            const cardElement = createCard(
                                card.id,
                                card.title,
                                card.description,
                                card.tempo,
                                card.team?.name,
                                card.tags,
                                card.project_id,
                                card.deadline,
                                card.users
                            );
                            column.appendChild(cardElement);
                        }
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading board');
                });
        }


        document.addEventListener('DOMContentLoaded', function() {
            const projectFilter = document.getElementById('projectFilter');
            if (projectFilter) {
                projectFilter.addEventListener('change', applyFilters);
            }
        });


        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectFilter = document.getElementById("projectFilter");
                    const newCardProject = document.getElementById("newCardProject");
                    const options = '<option value="">All Projects</option>' + 
                        projects.map(project => `
                            <option value="${project.id}">${project.name}</option>`
                        ).join('');
                    
                    projectFilter.innerHTML = options;
                    newCardProject.innerHTML = options.replace('All Projects', 'Select Project');
                    
                    applyFilters();
                });
        }


        function showModal(modalId) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
            document.getElementById(modalId).style.display = "block";
        }


        function openTeamModal() {
            showModal('teamModal');
            loadTeamsList();
        }


        function openTagModal() {
            showModal('tagModal');
            loadTagsList();
        }


        function openProjectModal() {
            showModal('projectModal');
            loadProjectsList();
        }


        window.onload = function() {
            loadTags();
            loadTeams();
            loadProjects();
            applyFilters();
        };


        loadTags();


        loadTeams();


        {% for card in cards %}
            document.getElementById("{{ card.column }}").appendChild(
                createCard(
                    "{{ card.id }}",
                    "{{ card.title }}",
                    "{{ card.description }}",
                    "{{ card.tempo }}",
                    "{{ card.team.name if card.team else '' }}",
                    [
                        {% for tag in card.tags %}
                            {
                                id: {{ tag.id }},
                                name: "{{ tag.name }}",
                                color: "{{ tag.color }}"
                            }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                    "{{ card.project_id }}",
                    "{{ card.deadline }}",
                    {{ card.users | tojson }}
                )
            );
        {% endfor %}


        function openProjectModal() {
            document.getElementById("projectModal").style.display = "block";
            loadProjectsList();
        }


        function closeProjectModal() {
            document.getElementById("projectModal").style.display = "none";
        }


        function createProject() {
            const name = document.getElementById("projectName").value;
            const description = document.getElementById("projectDescription").value;
            const phases = getPhases();

            if (!name) {
                alert('Project name is required!');
                return;
            }

            if (phases.length === 0) {
                alert('At least one phase is required!');
                return;
            }

            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    description,
                    phases
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeProjectModal();
                    loadProjects();
                } else {
                    alert('Error creating project: ' + data.error);
                }
            });
        }


        function loadProjects() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectFilter = document.getElementById("projectFilter");
                    const newCardProject = document.getElementById("newCardProject");
                    const options = '<option value="">All Projects</option>' + 
                        projects.map(project => `
                            <option value="${project.id}">${project.name}</option>`
                        ).join('');
                    
                    projectFilter.innerHTML = options;
                    newCardProject.innerHTML = options.replace('All Projects', 'Select Project');
                });
        }


        function loadProjectsList() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectsList = document.getElementById("projectsList");
                    projectsList.innerHTML = '';
                    
                    projects.forEach(project => {
                        projectsList.innerHTML += `
                            <div class="project-item">
                                <span>${project.name}</span>
                                <div>
                                    <button onclick="editProject(${project.id})">Edit</button>
                                    <button onclick="deleteProject(${project.id})">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                });
        }


        function searchCards() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.kanban-card');
            
            cards.forEach(card => {
                const title = card.querySelector('h3').textContent.toLowerCase();
                const description = card.getAttribute('data-description').toLowerCase();
                const tempo = card.querySelector('p:nth-child(2)').textContent.toLowerCase();
                const tags = Array.from(card.querySelectorAll('.card-tag'))
                    .map(tag => tag.textContent.toLowerCase());
                const users = Array.from(card.querySelectorAll('.user-tag'))
                    .map(user => user.textContent.toLowerCase());
                const teamTag = card.querySelector('.team-tag');
                const teamName = teamTag ? teamTag.textContent.toLowerCase() : '';

                const isVisible = title.includes(searchTerm) || 
                                description.includes(searchTerm) || 
                                tempo.includes(searchTerm) ||
                                tags.some(tag => tag.includes(searchTerm)) ||
                                users.some(user => user.includes(searchTerm)) ||
                                teamName.includes(searchTerm);
                
                card.style.display = isVisible ? 'block' : 'none';
            });
        }


        document.getElementById('searchInput').placeholder = 'Buscar por título, descrição, tags, usuários...';


        document.getElementById('searchInput').addEventListener('input', searchCards);


        document.addEventListener('click', function(e) {
            if (e.target.matches('.add-card-button')) {
                openNewCardModal(e.target.closest('.kanban-column').id);
            }
        });


        function openShareModal() {
            document.getElementById('shareModal').style.display = 'block';
            document.getElementById('shareEmail').value = '';
        }


        function closeShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }


        function sendShareEmail() {
            const email = document.getElementById('shareEmail').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                alert('Por favor, insira um email válido');
                return;
            }

            fetch('/api/share', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Email enviado com sucesso!');
                    closeShareModal();
                } else {
                    alert('Erro ao enviar email: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erro ao enviar email');
            });
        }

        function toggleConfigModal() {
            const modal = document.getElementById('configModal');
            if (modal.style.display === 'block') {
                modal.style.display = 'none';
            } else {
                modal.style.display = 'block';
            }
        }

        function saveConfig() {
            // Aqui você pode adicionar a lógica para salvar as configurações
            alert('Configurações salvas!');
            toggleConfigModal();
        }

        // Fechar o modal quando clicar fora dele
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('configModal');
            const configButton = event.target.closest('.config-button');
            const modalContent = event.target.closest('.config-modal');
            
            if (!configButton && !modalContent && modal.style.display === 'block') {
                modal.style.display = 'none';
            }
        });

        function editProject(projectId) {
            fetch(`/api/projects/${projectId}`)
                .then(response => response.json())
                .then(project => {
                    document.getElementById("editProjectId").value = projectId;
                    document.getElementById("editProjectName").value = project.name;
                    document.getElementById("editProjectDescription").value = project.description || '';
                    document.getElementById("editProjectModal").style.display = "block";
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading project data');
                });
        }

        function saveProjectEdit() {
            const id = document.getElementById("editProjectId").value;
            const name = document.getElementById("editProjectName").value;
            const description = document.getElementById("editProjectDescription").value;

            if (!name) {
                alert("Project name is required!");
                return;
            }

            fetch(`/api/projects/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    description: description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeEditProjectModal();
                    loadProjectsList();
                    loadProjects();
                } else {
                    alert('Error updating project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating project');
            });
        }

        function closeEditProjectModal() {
            document.getElementById("editProjectModal").style.display = "none";
        }

        function deleteProject(projectId) {
            if (!confirm('Are you sure you want to delete this project? This will also delete all associated cards.')) {
                return;
            }

            fetch(`/api/projects/${projectId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadProjectsList();
                    loadProjects();
                } else {
                    alert('Error deleting project: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting project');
            });
        }

        function loadProjectsList() {
            fetch('/api/projects')
                .then(response => response.json())
                .then(projects => {
                    const projectsList = document.getElementById("projectsList");
                    projectsList.innerHTML = '';
                    
                    projects.forEach(project => {
                        projectsList.innerHTML += `
                            <div class="project-item">
                                <div class="project-info">
                                    <span class="project-name">${project.name}</span>
                                    <span class="project-description">${project.description || ''}</span>
                                </div>
                                <div class="project-actions">
                                    <button onclick="editProject(${project.id})" class="edit-btn">Edit</button>
                                    <button onclick="deleteProject(${project.id})" class="delete-btn">Delete</button>
                                </div>
                            </div>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error loading projects list');
                });
        }

        function loadBoard(projectId) {
            if (!projectId) {
                document.querySelector('.kanban-board').innerHTML = '<p>Please select a project</p>';
                return;
            }

            fetch(`/api/projects/${projectId}/phases`)
                .then(response => response.json())
                .then(phases => {
                    const board = document.querySelector('.kanban-board');
                    board.innerHTML = '';
                    
                    phases.forEach(phase => {
                        const column = document.createElement('div');
                        column.className = 'kanban-column';
                        column.id = `phase_${phase.id}`;
                        column.setAttribute('ondrop', 'drop(event)');
                        column.setAttribute('ondragover', 'allowDrop(event)');
                        
                        column.innerHTML = `
                            <div class="column-header">
                                <h2>${phase.name}</h2>
                                <button class="add-card-button" onclick="openNewCardModal(${phase.id})" title="Add new card">+</button>
                            </div>
                        `;
                        
                        board.appendChild(column);
                    });
                    
                    // Recarregar os cards do projeto
                    loadProjectCards(projectId);
                });
        }

        function loadProjectCards(projectId) {
            fetch(`/api/cards?project_id=${projectId}`)
                .then(response => response.json())
                .then(cards => {
                    // Limpar todos os cards existentes
                    document.querySelectorAll('.kanban-card').forEach(card => card.remove());
                    
                    // Adicionar os cards nas colunas corretas
                    cards.forEach(card => {
                        const column = document.getElementById(`phase_${card.phase_id}`);
                        if (column) {
                            column.appendChild(createCard(
                                card.id,
                                card.title,
                                card.description,
                                card.tempo,
                                card.team?.name,
                                card.tags,
                                card.project_id,
                                card.deadline,
                                card.users
                            ));
                        }
                    });
                });
        }

        // Atualizar o event listener do filtro de projeto
        document.getElementById('projectFilter').addEventListener('change', function(e) {
            const projectId = e.target.value;
            if (projectId) {
                loadBoard(projectId);
            }
        });

        function addPhaseInput() {
            const phasesList = document.getElementById('phasesList');
            const phaseDiv = document.createElement('div');
            phaseDiv.className = 'phase-input';
            phaseDiv.innerHTML = `
                <input type="text" placeholder="Phase Name" class="phase-name">
                <button onclick="this.parentElement.remove()">Remove</button>
            `;
            phasesList.appendChild(phaseDiv);
        }

        function getPhases() {
            return Array.from(document.querySelectorAll('.phase-name'))
                .map(input => ({
                    name: input.value
                }))
                .filter(phase => phase.name.trim() !== '');
        }

        // Atualizar as funções de criação e edição de projeto
        function createProject() {
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDescription').value;
            const phases = getPhases();

            if (!name) {
                alert('Project name is required!');
                return;
            }

            if (phases.length === 0) {
                alert('At least one phase is required!');
                return;
            }

            fetch('/api/projects', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name,
                    description,
                    phases
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeProjectModal();
                    loadProjects();
                } else {
                    alert('Error creating project: ' + data.error);
                }
            });
        }

        function loadPhasesByProject(projectId) {
            if (!projectId) {
                document.getElementById('newCardPhase').innerHTML = '<option value="">Select Phase</option>';
                return;
            }

            fetch(`/api/cards/phases/${projectId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const phaseSelect = document.getElementById('newCardPhase');
                        phaseSelect.innerHTML = '<option value="">Select Phase</option>' +
                            data.phases.map(phase => 
                                `<option value="${phase.id}">${phase.name}</option>`
                            ).join('');
                    } else {
                        console.error('Error loading phases:', data.error);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Ao carregar a página
        window.onload = function() {
            loadTags();
            loadTeams();
            loadProjects();
        };
    </script>
    <footer class="footer">o, antes do </body> -->
        © 2024 GrittiCorp. All rights reserved.
    </footer>t { searchCards } from "{{ url_for('static', filename='js/modules/search.js') }}";
</body> import { applyFilters } from "{{ url_for('static', filename='js/modules/filters.js') }}";
</html> import { showModal, closeModal, openProjectModal, openTeamModal, openTagModal } from "{{ url_for('static', filename='js/modules/modals.js') }}";
        import { loadProjects, loadProjectsList } from "{{ url_for('static', filename='js/crud/projects.js') }}";
        import { loadTeams, loadTeamsList } from "{{ url_for('static', filename='js/crud/teams.js') }}";
    
        // Inicialização dos eventos
        document.addEventListener('DOMContentLoaded', function() {
            // Event Listeners
            document.getElementById('searchInput').addEventListener('input', searchCards);
            document.getElementById('projectFilter').addEventListener('change', applyFilters);
            
            // Initial Loads
            loadTeams();
            loadProjects();
            applyFilters();
        });
    </script>
</body>
</html>
```
</copilot-edited-file>